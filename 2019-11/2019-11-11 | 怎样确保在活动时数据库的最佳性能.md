# 怎样确保在活动时数据库的最佳性能



- 我们注意力的持续时间越来越短。来自微软的广泛研究声称，现在的平均注意力时间小于金鱼的平均注意力时间九秒！同样的，谷歌最近的一项研究发现，53%的移动用户在页面加载时间超过三秒就会离开。
- 由于用户的期望值一直都很高，而注意力的持续时间一直都很低。因此，每秒钟的停机时间可能会使您的企业损失数百万的客户和收入。
- 当前和新兴的工具可以帮助提高性能并更易于扩展，但要充分利用它们，必须由专家进行管理和部署，他们必须了解其优点和局限性。
## 为应对高流量，数据库在预案时应采取的5个操作
- 每项业务都依赖于数据来为客户提供产品和服务。无论是您网站上的商品清单，还是需要联系您的分销商提供库存，或跟踪发货，付款，或者客户数据，您的数据库为了业务正常需要持续运行、优化并且可用。最重要的是，客户的体验和满意度取决于数据管理的成功度。
- 在高流量活动期间，例如黑色星期五、剁手星期一、奥运会或者其他世界性赛事或给您的网站带来高用户流量的行业活动，数据库环境的性能十分重要。如果您的数据库没有为突然增长的需求做准备，可能会导致响应延时，加载时间变长。如果您不能处理这些流量高峰，这会给您的用户带来糟糕的体验，这可能会导致收入和品牌价值的损失。
- 在最糟糕的情况下，流量峰值可能导致您的网站和应用程序崩溃。研究表明79%的客户不太可能回到一个缓慢的网站，所以如果您的网站表现不佳，他可能导致潜在用户永远离开。
- 您的数据库是否已为巨大的工作负载高峰做好了准备？他能处理高流量的情况吗？如果您不知道这个答案，我们可以帮助您。按照这个checklist，衡量您的数据库的高流量和高可用性。
### 衡量过去的流量，然后增长10%
- 查看您的数据库环境是否可以应对工作负载高峰的最佳途径之一是衡量过去一年的流量水平，在其基础上增加10%。过去的流量不仅仅是给了您一个工作的基准，如果您以前遇到过问题，您也会发现它们是否已经解决了。同样，通过增加指定的量，您可以判断您的解决方案是否足以满足年复一年的预计增长。然后，根据您的业务预期，根据附加场景增加更多的流量（25-50%）。
### 制定备份和灾难恢复策略
- 您安装好数据库环境，对其优化性能，满足高可用，并根据数据优化了查询语句。然而，不管您的计划有多好，数据库灾难仍会发生在任何时间。如果数据库宕机-即使是无法控制的事件-您的应用程序会慢慢停止。为应对这种最糟糕的情况，您需要确保自己是否有良好的数据备份和恢复计划。确保将过程文档化，并与所有的关键人物共享。鼓励这么做，避免了在故障期间关键人员无法联系的单点故障。
### 制定监控计划
- 在高流量活动之前、活动期间、活动之后您都需要监控您的数据库环境。查看QPS、SQL响应时间是否增加、以及磁盘和CPU的利用率和饱和度。一个可靠的监控计划可以帮助您预测问题，制定备份计划并留出资源以防止数据库崩溃。
### 有适当的资源
- 您的数据库环境不仅仅是应用程序和网页在硬件、软件和体系结构如何交互。数据库管理人员或团队很容在在高流量场景时不断修复系统故障中不堪重负，特别是没有“停机时间”的大环境情况下。确保您有足够的员工7*24响应，并具有足够的能力，以快速诊断和实施解决方案。
### 压测和验证
- 在数据库环境就位后，进行压测。确保性能符合预期。相关关键人完全理解您的应急计划。加大压力找到数据库宕机的临界点。运行多个故障场景并衡量恢复时间。最好搞清楚在紧急情况发生前系统的任何异常。
## 为黑色星期五高流量场景准备您的数据库
- 现在是11月，我们都知道这意味着，这是销售旺季，没有比黑色星期五流量更大的日期了（我大双11不服！）但是您的数据库将如何处理所有这些新的无情流量？您的数据库不仅仅需要快速处理这些流量，但是web服务器有时候将这些突增流量视为攻击，这意味着您的网站可能会完全崩溃。
- 每年都有这样的新闻报道：当潜在的消费者在线时，一些网站没有响应或者完全宕机。不要让那个成为你！确认我们应该为高流量事件准备些什么，阅读第一部分看看我们建议您在高峰期之前，之中和之后应该做什么。让我们开始。
### 您应该了解高流量活动
- 1.您的用户期望您的应用程序能够立即响应并给予反馈。如果您不给予他们，您的竞争对手就会。
- 2.您的数据库变慢可能被客户视为停机，他们将对您的能力失去信心。
- 3.几秒钟的宕机不仅带来直接损失，还会损失未来的业务。使用我们的数据库停机时间成本计算器，看看您可以花费多少的停机时间。
- 4.当您对一个慢系统进行故障转移时，慢查询会随之转移到新的系统。如果慢查询减少了，可能是因为您的用户在你停机的时候去了别的地方。
- 5.时间是有限的，您不能获得更多。您必须充分利用它。它可能比金钱更有价值。
### 在活动之前
- 1.在活动之前安装监控和工具。如果您无法看到正在发生了什么，您怎样衡量您的成功？PMM在这个方面可以帮助您。
- 2.对应用程序进行压力测试，并测试如何在正常负载和峰值负载下伸缩。发现瓶颈的最佳时间是在活动之前，因为在活动期间成本很高，影响也很大。
- 3.测试故障转移并了解花费多久可以恢复。在一年中最繁忙的一天发现故障转移不工作是最糟糕的时候。
- 4.在活动之前将配置和代码封版，如果应用程序仍在更新，就很难确保性能。
- 5.征求别人的意见，仔细检查，不要想当然。您的大部分业务都与这次活动有关。确认一切都准备好了，这是值得的。大多数的长时间停机都是由容易被忽视的事情引起的。
- 6.检查您的备份。确认您的数据库有可靠和一致性的备份。这将更容易恢复一个崩溃的数据库。Percona XtraBackup for MySQL会对此有所帮助。
### 在活动时
- 1.意识到故障转移到其他系统绝对是最后的选择。对一个繁忙的系统做故障转移是将流量转移到新的服务器。此外，大多数系统在增加流量时速度会变慢，因为它需要花费时间来预热缓存。
- 2.在问题失控前，让正确的人监控、调整和修复问题。太多的问题因为等待合适的人来解决而拖延。许多大公司都将此作为一项全员参与的事件。
- 3.不要忘记目标！重新启动和运行并允许客户访问站点是您的目标，而不是立即开发一个永久解决方案。产生影响的时间是有限的，但是同样重要的人在压力下更容易犯错。一个更简单的临时解决方案可以助您一臂之力，只要您不要忘记使其最终成为永久的。
- 4.不要把问题弄得更糟。有些活动可能会导致级联缓慢...在更改之前要了解更改的影响。我们接到许多人的电话，他们本想解决一个小问题，但却制造了一个更大的问题。不好好心做错事。
- 5.收集和存储数据可以帮助您为下一次活动做分析和改善。通常情况下，当事情不顺利时，问题往往很短，而且事后难以理解。无论活动进展顺利与否，都要收集您需要的数据。
### 在活动之后
- 1.分析并了解您的流量和使用情况。使用这些数据为未来的活动规划，扩容和调整您的策略。
- 2.不要把权宜之计留在原地，忘记它们，它们可能在最糟糕的时候升级。在空闲时间花费时间和精力来修复它们。
- 3.从错误中汲取教训，制定计划来规避未来的问题和风险。
- 4.将您的系统更新到最新的版本，并安装最新的安全更新。
- 5.不要自满。恭喜您今年生存下来，但是每个应用程序和用户群都是一个活生生的实体，去年有效的方法可能今年无效。您必须定期进行分析、制定计划和复习。
