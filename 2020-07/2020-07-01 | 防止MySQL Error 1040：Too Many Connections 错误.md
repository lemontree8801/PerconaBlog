- [原文链接](https://www.percona.com/blog/2020/07/01/preventing-mysql-error-1040-too-many-connections/)


# 防止MySQL Error 1040：Too Many Connections 错误
MySQL中最常遇到的报错之一是臭名昭著的**Error 1040**：
```
ERROR 1040 (00000): Too many connections
```
实际上，这意味着MySQL实例已经到达了客户端连接的最大允许限制。在连接关闭之前，服务端不会接受任何新连接。

我想说明一下预防这种情况的实用建议，或者如果您遇到这种情况，如何恢复。

## 对max_connections参数准确调优
此设置定义MySQL实例将接受的最大连接数。对于“为什么”需要有最大连接数的考虑基于服务端可用资源和应用程序使用模式。允许不受控制的连接可能导致服务端崩溃，这可能比阻止更多连接“更糟糕”。`Max_connections`是一个用于保护服务端的值，而不是用于修复与连接劫持有关的问题。

每个到服务端的连接将消耗固定量的开销，比如管理连接的“线程”和用于管理它的内存，以及可变的资源（例如用于创建内存表的内存）。重要的是要对应用程序使用的资源有一定估量，并找到超出连接数的危险点。

PMM可以帮助您找到这些值。查看内存使用、正在运行的线程，并将它们与连接数关联起来。PMM还可以显示连接活动的峰值，让您了解离阈值还多少。进行相应的调优，记住服务的资源约束。

下面是一个非常稳定的连接的服务端，在最多使用和最大连接之间有很大的空间。

![enter image description here](https://www.percona.com/blog/wp-content/uploads/2020/07/Screen-Shot-2020-06-30-at-2.26.15-PM.png)

## 避免导致连接过度使用的常见场景
在Percona管理服务团队工作多年后，我有第一手的机会，看到许多企业因为建立过多连接而陷入“麻烦”。传统的观点认为，通常是糟糕的代码导致应用程序没有关闭打开的连接，或者因为一些无关紧要的原因快速打开了太多连接。

即使应用程序“按预期”运行，我还看到过其他一些导致这种情况的场景。考虑一个利用缓存的应用程序堆栈。随着时间的推移，应用程序规模不断扩大。现在考虑一下如果缓存被完全清除的负载情况。应用程序可能会尝试大量重新填充缓存，进而产生峰值，使服务不堪重负。

重要的是考虑使用MySQL服务的系统，防止可能导致问题的这类极端情况。如果可能，最好在应用程序中捕捉错误，如果遇到"Too many connections"，最好让应用降级一段时间，然后再重试以减少连接池压力。

## 保护自己不被锁在外面
MySQL实际上给了您免于被拒之门外的方法。在5.xx版本中，`SUPER`用户始终有一个可用的连接，在8.xx版本中，有`CONNECTION_ADMIN`权限的用户始终有一个可用连接。但是，很多时候系统的权限分配不严格，可能应用程序用户被授予了这些权限，导致使用了这个额外的紧急连接。审计用户并确保只有真正的管理员才有这些权限是一个好主意，这样如果服务端消耗了所有可用连接，管理员可以介入并采取措施。严格权限还有其他好处。请记住，最小权限策略通常是最佳实践，没有理由！不仅仅是出于“安全”。

MySQL8.0.14+还允许我们指定`admin_address`和`admin_port`来指定一个完全不同的入口，绕过主端口并建立一个专用的管理连接。如果您运行的版本较低，但是使用的是Percona版MySQL，那么您可以选择使用`extra_port`和`extra_max_connections`来实现另一种连接方式。

如果您能够用管理账户登陆，您可以杀死连接，使用`pt-kill`杀掉打开的连接，调整超时，禁用违规账户，或者放大`max_connections`参数。

如果您无法登陆，您可以尝试动态调整`max_connections`参数作为最终手段。参阅[Too many connections? No problem!](https://www.percona.com/blog/2010/03/23/too-many-connections-no-problem/)

## 使用代理
另一种缓解连接问题（或者说是将问题转移到另一层）的方法是使用代理，比如ProxySQL来处理多路复用。参阅[Multiplexing (Mux) in ProxySQL: Use Case](https://www.percona.com/blog/2019/09/27/multiplexing-mux-in-proxysql/)。

## 每个用户的限制
MySQL可以用于确定是否允许连接的另一个参数是`max_user_connections`。通过设置这个值，它可以限制任何给定用户的连接数。如果您的应用程序用户数量较少，可以限制其连接使用量，那么您可以适当设定这个参数，以防止超出总连接的最大值。

例如，如果我们知道我们有三个应用程序用户，并且我们希望这三个用户每个不会超过300个连接，那么我们将`max_user_connections`设置为300。这样3个应用程序用户，只允许总共900个连接。如果`max_connections`设置为1000，那么我们还有100个连接可以使用。

另一个更细粒度的方法是限制每个用户账户的连接。如下，您可以创建一个这样账户：
```
CREATE USER 'user'@'localhost' IDENTIFIED BY 'XXXXXXXX' WITH MAX_USER_CONNECTIONS 10;
```

最好限制与您环境中新引入的工具/应用程序/监控的连接，并确保它们不会“偶然”消耗过多的连接。

## 关闭不使用的连接
MySQL提供了`wait_timeout`参数。如果您观察到连接随着时间的推移逐渐上升，未达到峰值（您的应用程序可以处理连接数），那么您可能希望将该参数从默认的288000秒减少到更合理的值。这会让服务端关闭休眠连接。

这些只是处理"Too Many Connections"时的一些思路。我希望这些可以帮助您。您也可以参阅之前的Blog[MySQL Error: Too many connections](https://www.percona.com/blog/2013/11/28/mysql-error-too-many-connections/)。
